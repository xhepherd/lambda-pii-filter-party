const PII_PATTERN_FOR_PATHS=new RegExp("(/(setup/redirect|licenses)/)[^/?\\s]*","g"),PII_PATTERN_FOR_PARAMS=new RegExp("((password|password_confirmation|cc_no|ccv|authenticity_token|email|activation_code|code|token|first_name|last_name|address1|city|state|payerid|xv3v2ksky|credit_card|date|offer_code|auth_token|reset_password|reset_password_token|signup%255B\\w*\\%255D|signup%5B\\w*\\%5D|signup\\[\\w*\\])=)[^&\\s]*","g");function removePII(e){return removePIIFromPaths(removePIIFromParams(e))}function removePIIFromParams(e){return e.replace(PII_PATTERN_FOR_PARAMS,"$1[FILTERED]")}function removePIIFromPaths(e){return e.replace(PII_PATTERN_FOR_PATHS,"$1[FILTERED]")}function parseHeaders(e,t){const r={};for(let s=0;s<e.length;s+=1){const o=t.indexOf(e[s].name.toLowerCase());if(-1!==o){r[t[o].replace("-","_").toLowerCase()]=e[s].value}}return r}exports.removePII=removePII,exports.parseHeaders=parseHeaders,exports.handler=((e,t,r)=>{if(!e.deliveryStreamArn)return r("Not Kinesis delivery stream event","ERROR"),!1;return r(null,{records:e.records.map(e=>{const t=JSON.parse(Buffer.from(e.data,"base64").toString("utf8")),r=parseHeaders(t.httpRequest.headers,["host","user-agent"]),s=JSON.stringify({timestamp:t.timestamp,terminatingRuleId:t.terminatingRuleId,terminatingRuleType:t.terminatingRuleType,action:t.action,httpSourceId:t.httpSourceId,clientIp:t.httpRequest.clientIp,country:t.httpRequest.country,host:r.host,user_agent:r.user_agent,uri:removePIIFromPaths(t.httpRequest.uri),args:removePIIFromParams(t.httpRequest.args),httpVersion:t.httpRequest.httpVersion,httpMethod:t.httpRequest.httpMethod,requestId:t.httpRequest.requestId})+"\n";return{recordId:e.recordId,result:"Ok",data:Buffer.from(s,"utf8").toString("base64")}})}),!0});